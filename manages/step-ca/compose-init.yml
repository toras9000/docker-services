name: docker-services-step-ca-init

#  docker compose -f ./compose-init.yml run --rm init

services:
  prepare:
    image: busybox
    command: chown 1000:1000 -R /home/step
    volumes:
      - type: bind
        source: ./assets/step
        target: /home/step
        bind:
          create_host_path: true

  init:
    image: smallstep/step-ca:0.28.4
    depends_on:
      prepare:
        condition: service_completed_successfully
    entrypoint: bash -c "
        mkdir -p /home/step/secrets
     && cat /dev/urandom | tr -dc "[:alnum:]" | head -c 40 > /home/step/secrets/password
     && step ca init 
            --root=/init-data/ca.crt --key=/init-data/ca.key
            --deployment-type=standalone
            --name=sample-ca
            --dns=ca.myserver.home
            --dns=step-ca-app-container
            --provisioner=default
            --address=0.0.0.0:443
            --acme
            --password-file=/home/step/secrets/password
            --provisioner-password-file=/home/step/secrets/password
      "
    tty: true
    stdin_open: true
    volumes:
      - type: bind
        source: ./assets/step
        target: /home/step
        bind:
          create_host_path: true
      - type: bind
        source: ./temp/ca
        target: /init-data
        read_only: true
        bind:
          create_host_path: false
    environment:
      - TZ=Asia/Tokyo
